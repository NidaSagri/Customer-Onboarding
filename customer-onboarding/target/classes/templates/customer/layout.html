<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>

    <!-- Sidebar Fragment -->
    <aside class="sidebar" th:fragment="sidebar">
        <h3>My Banking</h3>
        <ul>
            <li><a th:href="@{/customer/dashboard}">Dashboard</a></li>
            <!-- Links are only shown if the user has an account -->
            <li th:if="${account != null}"><a th:href="@{/customer/transfer}">Transfer Funds</a></li>
            <li th:if="${account != null}"><a th:href="@{/customer/transactions}">Transactions</a></li>
        </ul>

        <!-- CHATBOT UI - INTEGRATED HERE -->
        <div class="chatbot-container">
            <h4>AI Assistant</h4>
            <div id="chat-window" class="chat-window">
                <p><strong>Bot:</strong> Hello! Ask me about your account balance or transactions.</p>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Ask about your account...">
                <button id="send-btn" class="btn btn-sm">Send</button>
            </div>
        </div>
    </aside>

    <!-- Chatbot Javascript Fragment (UPDATED TO SEND USERNAME) -->
    <th:block th:fragment="chatbot-js">
        <script>
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            // --- NEW: Get the username from the body's data attribute ---
            const loggedInUsername = document.body.dataset.username;

            let chatHistory = [];

            async function sendMessage() {
                const query = chatInput.value.trim();
                if (!query) return;

                appendMessage('You', query);
                chatInput.value = '';
                appendMessage('Bot', 'Thinking...');

                try {
                    // Send the username along with the request
                    const response = await fetch('http://localhost:5000/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: query,
                            role: 'CUSTOMER',
                            history: chatHistory,
                            username: loggedInUsername // <-- SEND THE USERNAME
                        })
                    });
                    
                    chatWindow.removeChild(chatWindow.lastChild);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    appendMessage('Bot', data.response);
                    chatHistory = data.history;

                } catch (error) {
                    console.error('Chatbot error:', error);
                    chatWindow.removeChild(chatWindow.lastChild);
                    appendMessage('Bot', 'Sorry, an error occurred.');
                }
            }

            function appendMessage(sender, message) {
                const p = document.createElement('p');
                const sanitizedMessage = message.replace(/</g, "<").replace(/>/g, ">").replace(/\n/g, '<br>');
                p.innerHTML = `<strong>${sender}:</strong> ${sanitizedMessage}`;
                chatWindow.appendChild(p);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        </script>
    </th:block>

</body>
</html>